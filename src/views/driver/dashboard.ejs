<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VayaRide ‚Ä¢ Driver Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#000; --card:#0f0f0f; --text:#fff; --muted:#bbb; --accent:#fff; --border:#222; --ok:#00e676; --warn:#ffd166; --err:#ff4d4d; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Arial,sans-serif}
    header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:#000;z-index:2}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{width:50px;height:50px;border-radius:50%;border:2px solid #fff;object-fit:cover}
    .brand h1{font-size:18px;margin:0}
    .actions a, .actions form button{appearance:none;background:#111;border:1px solid var(--border);color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none;margin-left:8px;cursor:pointer}
    .actions a:hover, .actions form button:hover{filter:brightness(1.2)}
    main{max-width:1100px;margin:0 auto;padding:20px;display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:960px){ main{grid-template-columns:1fr 1fr} }
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:18px}
    h2{margin:0 0 12px;font-size:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid .item{background:#111;border:1px solid var(--border);border-radius:8px;padding:12px}
    .muted{color:var(--muted)}
    .status{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#111}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.pending{background:var(--warn)}
    .dot.approved{background:var(--ok)}
    label{font-size:14px;margin:8px 0 6px;display:block}
    input,select{width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:#1a1a1a;color:#fff}
    input[type=file]{padding:8px;background:#111}
    .hint{font-size:12px;color:#aaa;margin-top:4px}
    .size-tag{font-size:12px;color:#bbb;margin-left:6px}
    button.primary{margin-top:10px;width:100%;padding:12px 14px;border-radius:8px;border:1px solid var(--accent);background:var(--accent);color:#000;font-weight:700;cursor:pointer}
    button.primary:hover{filter:brightness(0.9)}
    .btn, .btn-danger{appearance:none;border-radius:8px;border:1px solid var(--border);background:#111;color:#fff;padding:6px 10px;cursor:pointer}
    .btn:hover{filter:brightness(1.2)}
    .btn-danger{border-color:#532; background:#1a0000}
    .btn-danger:hover{filter:brightness(1.2); background:#220000}
    .icon{font-style:normal; margin-right:6px}
    .note{font-size:13px;color:#aaa;margin-top:6px}
    .pill{padding:6px 10px;border-radius:999px;background:#111;border:1px solid #222}
    .banner{border:1px solid var(--border);padding:12px 14px;border-radius:10px;margin:10px 0;background:#0b0b0b}
    .banner.ok{border-color:#124;border-left:4px solid var(--ok)}
    .banner.err{border-color:#412;border-left:4px solid var(--err)}
    /* docs table */
    table.docs{width:100%;border-collapse:collapse;margin-top:8px}
    table.docs th, table.docs td{border-bottom:1px dashed #222;padding:10px;vertical-align:middle}
    table.docs th{color:#ddd;text-align:left;font-weight:600}
    .thumb{width:64px;height:64px;border:1px solid #222;border-radius:8px;object-fit:cover;background:#111}
    .empty{color:#999}
    .doc-actions a, .doc-actions form button{color:#fff;text-decoration:none;border:1px solid #333;padding:6px 10px;border-radius:8px;background:#111}
    .doc-actions a:hover, .doc-actions form button:hover{filter:brightness(1.2)}
    .doc-actions{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="https://res.cloudinary.com/darf17drw/image/upload/v1752064092/Untitled_design_2_wilxrl.png" alt="VayaRide" />
      <h1>VayaRide ‚Ä¢ Driver Dashboard</h1>
    </div>
    <div class="actions">
      <span class="pill">Hello, <%= (user && user.name) || 'Driver' %></span>
      <a href="/driver/upload-docs">Upload Docs</a>
      <form action="/driver/logout" method="POST" style="display:inline;">
        <button type="submit">Logout</button>
      </form>
    </div>
  </header>

  <main>
    <!-- Banners -->
    <% if (typeof ok !== 'undefined' && ok) { %>
      <section class="banner ok"><strong>‚úÖ Success:</strong> <%= ok %></section>
    <% } %>
    <% if (typeof err !== 'undefined' && err) { %>
      <section class="banner err"><strong>‚ùå Error:</strong> <%= err %></section>
    <% } %>

    <!-- Profile -->
    <section class="card">
      <h2>Your Profile</h2>
      <div class="grid">
        <div class="item">
          <div class="muted">Name</div>
          <div><%= (user && user.name) || '‚Äî' %></div>
        </div>
        <div class="item">
          <div class="muted">Email</div>
          <div><%= (user && user.email) || '‚Äî' %></div>
        </div>
        <div class="item">
          <div class="muted">Vehicle Type</div>
          <div><%= (user && user.vehicleType) || 'Not set' %></div>
        </div>
        <div class="item">
          <div class="muted">Application Status</div>
          <span class="status">
            <span class="dot <%= (user && user.status)==='approved' ? 'approved' : 'pending' %>"></span>
            <%= (user && user.status) || 'pending' %>
          </span>
        </div>
      </div>

      <!-- üîê Telegram PIN banner (added here) -->
  <!-- üîê Telegram PIN banner -->
<% if (user && user.status === 'approved' && user.botPin) { %>
  <div class="banner ok" style="margin-top:10px;border-left:4px solid #0f0;">
    <strong>Telegram PIN:</strong>
    <span style="font-size:18px;font-weight:800;letter-spacing:2px">****<%= user.botPin.slice(-2) %></span>
    <div class="note">Use this PIN to log in to the VayaRide Driver Telegram bot.</div>
  </div>
<% } %>


      <p class="note">If your status is <b>pending</b>, our team is reviewing your documents. You‚Äôll be able to use the driver bot after approval.</p>
    </section>

    <!-- Documents on file -->
    <section class="card" id="docs" style="grid-column: 1 / -1;">
      <h2>Documents on File</h2>
      <% const docs = (user && user.documents) || {}; %>
      <table class="docs">
        <thead>
          <tr>
            <th style="width:80px">Preview</th>
            <th>Document</th>
            <th>Status</th>
            <th style="width:220px">Action</th>
          </tr>
        </thead>
        <tbody>
          <% const rows = [
            ['driverProfilePhoto','Driver Profile Photo'],
            ['vehiclePhoto','Vehicle Photo'],
            ['idDocument','National ID'],
            ['vehicleRegistration','Vehicle Registration'],
            ['driversLicense','Driver‚Äôs License'],
            ['insuranceCertificate','Insurance Certificate'],
            ['pdpOrPsv','PDP / PSV'],
            ['dekraCertificate','DEKRA Certificate'],
            ['policeClearance','Police Clearance'],
            ['licenseDisc','License Disc'],
          ]; %>

          <% rows.forEach(([key,label]) => { 
               const url = docs[key];
               const isImg = url && /\.(jpg|jpeg|png|webp|gif)(\?|$)/i.test(url);
               const isPdf = url && /\.pdf(\?|$)/i.test(url);
          %>
            <tr>
              <td>
                <% if (url && isImg) { %>
                  <img class="thumb" src="<%= url %>" alt="<%= label %>" />
                <% } else if (url && isPdf) { %>
                  <div class="thumb" style="display:flex;align-items:center;justify-content:center;">PDF</div>
                <% } else if (url) { %>
                  <div class="thumb" style="display:flex;align-items:center;justify-content:center;">FILE</div>
                <% } else { %>
                  <div class="thumb" style="display:flex;align-items:center;justify-content:center;opacity:.5">‚Äî</div>
                <% } %>
              </td>
              <td><%= label %></td>
              <td>
                <% if (url) { %>
                  <span class="pill" style="border-color:#1f3;border-left:4px solid var(--ok)">Uploaded</span>
                <% } else { %>
                  <span class="pill empty">Not uploaded</span>
                <% } %>
              </td>
              <td class="doc-actions">
                <% if (url) { %>
                  <a class="btn" href="<%= url %>" target="_blank" rel="noopener">View</a>
                  <form action="/driver/delete-doc" method="POST" style="display:inline" onsubmit="return confirm('Delete this document?');">
                    <input type="hidden" name="key" value="<%= key %>" />
                    <button type="submit" class="btn-danger" title="Delete this document">
                      <span class="icon">üóëÔ∏è</span> Delete
                    </button>
                  </form>
                <% } else { %>
                  <span class="muted">‚Äî</span>
                <% } %>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
      <p class="note">Re-uploading a document will replace the one on file. You can also delete a document using the trash icon.</p>
    </section>

    <!-- Upload Documents -->
    <section class="card">
      <h2>Upload Required Documents</h2>
      <form id="docsForm" action="/driver/upload-docs" method="POST" enctype="multipart/form-data">
        <label>Driver Profile Photo <span class="size-tag" id="sz_driverProfilePhoto"></span></label>
        <input type="file" name="driverProfilePhoto" accept="image/*" <%= docs.driverProfilePhoto ? '' : 'required' %> />

        <label>Vehicle Photo (with Number Plate) <span class="size-tag" id="sz_vehiclePhoto"></span></label>
        <input type="file" name="vehiclePhoto" accept="image/*" <%= docs.vehiclePhoto ? '' : 'required' %> />

        <label>National Identity Document (PDF or Image) <span class="size-tag" id="sz_idDocument"></span></label>
        <input type="file" name="idDocument" accept="image/*,application/pdf" <%= docs.idDocument ? '' : 'required' %> />
        <div class="hint">If your PDF is over 10MB, export it at a lower DPI (150‚Äì200) or upload photos instead.</div>

        <label>Vehicle Registration (Logbook) <span class="size-tag" id="sz_vehicleRegistration"></span></label>
        <input type="file" name="vehicleRegistration" accept="image/*,application/pdf" <%= docs.vehicleRegistration ? '' : 'required' %> />

        <label>Driver's License <span class="size-tag" id="sz_driversLicense"></span></label>
        <input type="file" name="driversLicense" accept="image/*,application/pdf" <%= docs.driversLicense ? '' : 'required' %> />

        <label>Vehicle Insurance Certificate <span class="size-tag" id="sz_insuranceCertificate"></span></label>
        <input type="file" name="insuranceCertificate" accept="image/*,application/pdf" <%= docs.insuranceCertificate ? '' : 'required' %> />

        <label>Professional Driving Permit (PDP/PSV) <span class="size-tag" id="sz_pdpOrPsv"></span></label>
        <input type="file" name="pdpOrPsv" accept="image/*,application/pdf" <%= docs.pdpOrPsv ? '' : 'required' %> />

        <label>DEKRA Certificate <span class="size-tag" id="sz_dekraCertificate"></span></label>
        <input type="file" name="dekraCertificate" accept="image/*,application/pdf" <%= docs.dekraCertificate ? '' : 'required' %> />

        <label>Police Clearance (Good Conduct) <span class="size-tag" id="sz_policeClearance"></span></label>
        <input type="file" name="policeClearance" accept="image/*,application/pdf" <%= docs.policeClearance ? '' : 'required' %> />

        <label>Vehicle License Disc <span class="size-tag" id="sz_licenseDisc"></span></label>
        <input type="file" name="licenseDisc" accept="image/*,application/pdf" <%= docs.licenseDisc ? '' : 'required' %> />

        <button type="submit" class="primary">Upload Documents</button>
        <p class="note">Max file size: 10MB per file. Images are compressed automatically.</p>
      </form>
      <p class="note">By uploading, you agree your documents will be stored securely and reviewed by VayaRide admins.</p>
    </section>

    <!-- Vehicle Setup -->
    <section class="card">
      <h2>Vehicle Setup (Optional)</h2>
      <form action="/driver/vehicle" method="POST">
        <label for="vehicleType">Vehicle Type</label>
        <select id="vehicleType" name="vehicleType" required>
          <option value="normal" <%= (user && user.vehicleType==='normal') ? 'selected':'' %>>VayaRide ‚Ä¢ Normal</option>
          <option value="comfort" <%= (user && user.vehicleType==='comfort') ? 'selected':'' %>>VayaRide ‚Ä¢ Comfort</option>
          <option value="luxury" <%= (user && user.vehicleType==='luxury') ? 'selected':'' %>>VayaRide ‚Ä¢ Luxury</option>
          <option value="xl" <%= (user && user.vehicleType==='xl') ? 'selected':'' %>>VayaRide ‚Ä¢ XL</option>
        </select>

        <button class="primary" type="submit">Save Vehicle</button>
      </form>
      <p class="note">Your car category helps us estimate prices correctly for riders.</p>
    </section>
  </main>

  <script>
    // ---- Client-side image compression + size display ----
    const MAX_UPLOAD = 10 * 1024 * 1024; // 10MB
    const TARGET_MAX_W = 1800;           // px
    const TARGET_MAX_H = 1800;           // px
    const JPEG_QUALITY = 0.72;           // 0..1

    function fmtMB(bytes){ return (bytes/1024/1024).toFixed(2) + 'MB'; }

    function setSizeTag(input) {
      const tag = document.getElementById('sz_' + input.name);
      if (!tag) return;
      const f = input.files && input.files[0];
      tag.textContent = f ? `(${fmtMB(f.size)})` : '';
    }

    async function compressImageFile(file) {
      if (!file.type.startsWith('image/')) return file;
      const bitmap = await createImageBitmap(file);
      let { width, height } = bitmap;
      const scale = Math.min(1, TARGET_MAX_W / width, TARGET_MAX_H / height);
      const canvas = document.createElement('canvas');
      canvas.width = Math.round(width * scale);
      canvas.height = Math.round(height * scale);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
      const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', JPEG_QUALITY));
      if (!blob) return file;
      if (blob.size >= file.size) return file;
      return new File([blob], file.name.replace(/\.\w+$/, '.jpg'), { type: 'image/jpeg' });
    }

    function replaceInputFile(input, newFile) {
      const dt = new DataTransfer();
      dt.items.add(newFile);
      input.files = dt.files;
      setSizeTag(input);
    }

    document.querySelectorAll('input[type="file"]').forEach(input => {
      input.addEventListener('change', async (e) => {
        const f = e.target.files && e.target.files[0];
        if (!f) { setSizeTag(input); return; }
        if (f.type.startsWith('image/')) {
          try {
            const compressed = await compressImageFile(f);
            if (compressed !== f) replaceInputFile(input, compressed);
            else setSizeTag(input);
          } catch (err) {
            console.warn('Compression failed for', input.name, err);
            setSizeTag(input);
          }
        } else {
          setSizeTag(input); // PDFs or others: just display size
        }
      });
    });

    document.getElementById('docsForm').addEventListener('submit', (e) => {
      const inputs = e.currentTarget.querySelectorAll('input[type="file"]');
      for (const input of inputs) {
        const f = input.files && input.files[0];
        if (!f) continue;
        if (f.size > MAX_UPLOAD) {
          e.preventDefault();
          alert(`"${input.name}" is too large (${fmtMB(f.size)}). Max is 10MB.\n\nTip: If this is a PDF, re-export at lower DPI (150‚Äì200) or upload photos instead.`);
          return false;
        }
      }
      return true;
    });
  </script>
</body>
</html>
